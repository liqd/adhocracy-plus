<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>project insights - Adhocracy+</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "project insights";
        var mkdocs_page_input_path = "project_insights.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Adhocracy+
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">HOWTO</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../installation_dev/">install for development</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../django_shell_basics/">django basics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../management_commands/">management commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../languages_and_translations/">translations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../upgrades/">software upgrades</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../howtomkdocs/">create documentation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../installation_prod/">install on production</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Diagrams</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../diagrams_modules/">participation modules</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../api/">code reference</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Explanations</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../authentication/">authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../celery/">celery</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ckeditor/">ckeditor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../geolocation/">geolocation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../img_saving_and_deletion/">images</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../poll/">polls</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../postgresql/">postgresql</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">project insights</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#frontend">frontend</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#backend">backend</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#a4">a4</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#migrations">migrations</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../img_saving_and_deletion/">images</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../software_architecture/">architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tests/">tests</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Repository</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="https://github.com/liqd/adhocracy-plus">source code</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../contributing/">contribute</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Adhocracy+</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Explanations</li>
      <li class="breadcrumb-item active">project insights</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="structure">Structure</h2>
<h3 id="frontend">frontend</h3>
<ul>
<li>adhocracy-plus/assets/scss/components/_data_table.scss</li>
<li>adhocracy-plus/templates/a4dashboard/includes/project_result_form.html</li>
<li>apps/projects/templates/a4_candy_projects/project_detail.html</li>
</ul>
<h3 id="backend">backend</h3>
<ul>
<li>apps/projects/dashboard.py</li>
<li>apps/projects/insights.py</li>
<li>apps/projects/management/commands/reset_insights_table.py</li>
<li>apps/projects/models.py</li>
<li>apps/projects/signals.py</li>
<li>apps/projects/views.py</li>
</ul>
<h3 id="a4">a4</h3>
<ul>
<li>adhocracy4/projects/mixins.py</li>
</ul>
<h3 id="migrations">migrations</h3>
<ul>
<li>apps/projects/migrations/0005_projectinsight.py</li>
<li>apps/projects/migrations/0006_initialize_insights.py</li>
</ul>
<h2 id="background">Background</h2>
<p>The feature "Project Insights" is displaying a summary of user activity in the project details page. Among other numbers it should display how many active participants there are, how many ideas and comments were created and how many poll answers were submitted.</p>
<h2 id="developer-notes">Developer Notes</h2>
<p>Initially we thought about simply writing a query that counts all relevant objects (comments, ratings, ideas, ...), but we anticipated that it would be too slow for the project view to be queried on every page load.</p>
<p>We then decided to create a "data model", a table whose only purpose is to hold all insights numbers of a project. The result is the model "ProjectInsights".</p>
<p>The next problem was how do we initialise this table and how do we keep it up to date when data changes? One approach we discussed was a background task that updates the table every hour, for example, by running a query that counts all objects. It was decided that this is not up to date enough ("if I create a comment now, it should increase the comment count in the insights page immediately"). Hence we decided to create signals that update our insights table every time that ideas, comments, ratings etc are created or removed. This lead to a few tricky questions:</p>
<ul>
<li>should we decrease the count if a comment (for example) is deleted?</li>
<li>should we decrease the active participants count if all contributions are removed from a project?</li>
</ul>
<p>Also we discovered that whereas the number of comments and ideas can be a simple integer (simple increase or decrease when a comment is created or deleted), the number of active participants must be stored by a many-to-many relation because an active participant can author many objects and we only want to increase the number of active participants if it is the first contribution by that user.</p>
<p>We solved all challenges of keeping the data up to date by creating signals for the respective objects (ideas, comments, ratings etc).</p>
<p>Finally, we decided that we want to add a custom migration that initializes the insights table for all existing projects. The idea here was that our software is open source and people updating our software should be able to see the insights data without running management or deployment commands. The custom migration, on the other hand, is applied while installing or updating the software.</p>
<p>The custom migration (0006_initialize_insights.py) was hard to write because of the limited query manager access in custom migrations (Django's fake migration models). In particular, the generic relations on ratings and comments forced us to migrate by "looping and counting".</p>
<p>Finally, we added a management command ("reset_insights_table") to refresh the insights table. This code makes use of regular models (instead of Django's fake migration models) and can therefore be tested and keeps our options open for future background tasks and bug fixes.</p>
<h2 id="updates">Updates</h2>
<ul>
<li>With the new feature of the poll module optionally allowing unregistered users
  to vote, we had to find a way for the number of participants to include
unregistered users, as currently they are tied to the user as part of a m2m
relation. We introduced a new base model <code>GeneratedContent</code> which has an
optional field <code>creator</code> which is used if a registered user participated and an optional field
<code>content_id</code> for unregistered users. In case of a poll submission from an
unregistered user a unique uuid4 is created and
stored in <code>content_id</code> to allow counting the amount of unregistered users which
participated in the poll. We extended the <code>ProjectInsight</code> model with a
<code>unregistered_participants</code> field which stores this number.</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../postgresql/" class="btn btn-neutral float-left" title="postgresql"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../img_saving_and_deletion/" class="btn btn-neutral float-right" title="images">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../postgresql/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../img_saving_and_deletion/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
