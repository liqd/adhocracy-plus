<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>images - Adhocracy+</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "images";
        var mkdocs_page_input_path = "img_saving_and_deletion.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Adhocracy+
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">HOWTO</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../installation_dev/">install for development</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../django_shell_basics/">django basics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../management_commands/">management commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../languages_and_translations/">translations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../howtomkdocs/">create documentation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../installation_prod/">install on production</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Diagrams</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../diagrams_modules/">participation modules</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../api/">code reference</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Explanations</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../authentication/">authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../celery/">celery</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ckeditor/">ckeditor</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">images</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#general-info">General info</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#api">API</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#users">Users</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#project">Project</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#organisation">Organisation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#modules">Modules</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#idea">Idea</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#budgeting-mapidea-topicrio">Budgeting, MapIdea, Topicrio</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#budgeting">Budgeting</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mapidea">MapIdea</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#topicrio">Topicrio</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#interactive-event">Interactive Event</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#offlineevent">OfflineEvent</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#debate">Debate</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#document">Document</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#poll">Poll</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#map">Map</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../project_insights/">project insights</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">images</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#general-info">General info</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#api">API</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#users">Users</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#project">Project</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#organisation">Organisation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#modules">Modules</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#idea">Idea</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#budgeting-mapidea-topicrio">Budgeting, MapIdea, Topicrio</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#budgeting">Budgeting</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mapidea">MapIdea</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#topicrio">Topicrio</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#interactive-event">Interactive Event</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#offlineevent">OfflineEvent</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#debate">Debate</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#document">Document</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#poll">Poll</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#map">Map</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../software_architecture/">architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tests/">tests</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Repository</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="https://github.com/liqd/adhocracy-plus">source code</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../contributing/">contribute</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Adhocracy+</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Explanations</li>
      <li class="breadcrumb-item active">images</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="saving-and-deletion-of-images">Saving and deletion of images</h1>
<p><em>conforming to GDPR (General Data Protection Regulation) / DSGVO (Datenschutz-Grundverordnung)</em></p>
<h2 id="general-info">General info</h2>
<p>All image uploads in the platform, delete previous uploads. E.g when a user uploads a new profile picture, their past picture gets deleted.<br />
Same for projects, organisations and the modules, the new image will replace the old one.<br />
Images associated to users and organisations gets deleted when they are deleted. Images uploaded by users for projects and modules are not deleted when a user is deleted, except when the project or the modules are deleted.</p>
<h2 id="api">API</h2>
<p>The code implementation of the image replacement function is part of Adhocracy4.<br />
More specifically it happens in the files <a href="https://github.com/liqd/adhocracy4/blob/main/adhocracy4/images/services.py">images/service.py</a> and <a href="https://github.com/liqd/adhocracy4/blob/main/adhocracy4/images/signals.py">images/signals.py</a>.<br />
Inside <code>service.py</code> the function <code>delete_images</code> gets a list of image fields as a function attribute and deletes both the image and the thumbnail of each image field from their respective storage.
The <code>delete_images</code> function is called from the <code>signals.py</code> file, which defines what object actions (create, save, update, delete an object) should trigger signals.<br />
The signal <code>post_save</code> is triggered when an object (user, project, idea, etc) saves a new image, then the old ones, if any, are deleted (original upload and generated thumbnail) and the new ones are added as a list attribute.<br />
E.g <br />
<code>project.image</code> and <code>project.tile_image</code> 
are added as a list --&gt; <code>project._a4images_image_fields_current_images</code> 
which returns a list of the image paths<br />
The signal <code>post_init</code>, which is called every time an object is created, also sets the above attribute for the list of images associated to the object.
Finally, the signal <code>post_delete</code> deletes all the images asscociated with the object when the object is deleted.  </p>
<h2 id="users">Users</h2>
<p>user's image is refered to as <code>avatar</code> and it is saved under:</p>
<pre><code>       &quot;media/users/images&quot;
</code></pre>
<p>user avatar gets deleted when their account is deleted via the user dashboard in the browser, which calls the endpoint: </p>
<pre><code>accounts.views.AccountDeletionView.form_valid()

account_deletion  # the namespace defined in the accounts.urls.py
</code></pre>
<h2 id="project">Project</h2>
<p>Image storage for projects is categorised by date, and a project's two images are saved under:</p>
<pre><code>       &quot;media/projects/backgrounds/YYYY/MM/DD&quot;  # decorative background image
       &quot;media/projects/tiles/YYYY/MM/DD&quot;       # project's tile image
</code></pre>
<p>project images are deleted when its organisation is deleted, and when the project is deleted via the user dashboard in the browser, which calls the endpoint: </p>
<pre><code>projects.views.ProjectDeleteView
project-delete  # the namespace defined in projects.urls.py
</code></pre>
<h2 id="organisation">Organisation</h2>
<p>organisation's two images are saved under:</p>
<pre><code>&quot;organisations/logos&quot;
&quot;organisations/backgrounds&quot;  # header image
</code></pre>
<p>organisation images are deleted when organisation is deleted via django-admin (also this is how an organisation is created).<br />
When an organisation is deleted, all its related projects with their modules get deleted too.</p>
<h2 id="modules">Modules</h2>
<h3 id="idea">Idea</h3>
<p>Image storage for ideas is categorised by date, and an idea's image is saved under:</p>
<pre><code>       &quot;media/ideas/images/YYYY/MM/DD&quot;
</code></pre>
<p>idea image gets deleted when an idea is deleted via its idea detail page in the browser, which calls the endpoint:</p>
<pre><code>
ideas.views.IdeaDeleteView  # inherits from AbstractIdeaDeleteView
</code></pre>
<p>the URI is defined as:</p>
<pre><code>idea-delete  # defined in the ideas.urls.py
</code></pre>
<h3 id="budgeting-mapidea-topicrio">Budgeting, MapIdea, Topicrio</h3>
<p>for those modules, images are deleted when the module is deleted either via the module page or the user dashboard.
Their deletion inherits from the AbstractIdeaDeleteView and their images are also uploaded to:</p>
<pre><code>       &quot;media/ideas/images/YYYY/MM/DD&quot;
</code></pre>
<h3 id="budgeting">Budgeting</h3>
<p>Module is defined as Proposal and inherits from AbstractMapIdea, thus upload path is defined in the Parent class.
It gets deleted from the budget page in the browser and calls the endpoint:</p>
<pre><code>budgeting.views.ProposalDeleteView
proposal-delete  # the namespace defined in the budgeting.urls.py
</code></pre>
<h3 id="mapidea">MapIdea</h3>
<p>Module inherits from AbstractIdea, thus upload path is defined in the Parent class.
It gets deleted from the mapidea page in the browser and calls the endpoint:</p>
<pre><code>mapideas.views.MapIdeaDeleteView
mapidea-delete  # the namespace defined in the mapideas.urls.py
</code></pre>
<h3 id="topicrio">Topicrio</h3>
<p>Module inherits from adhocracy4 Item, thus upload path is defined in the child class and points to <code>media/ideas/images</code>.
It gets deleted from the user dashboard and thus it also inherits from adhocracy4.DashboardComponentFormSignalMixin.<br />
It calls the endpoint:</p>
<pre><code>topicrio.views.TopicDeleteView
topic-detail  # the namespace defined in the topicrio.urls.py
</code></pre>
<h3 id="interactive-event">Interactive Event</h3>
<p>Image is saved under:</p>
<pre><code>        &quot;media/interactiveevents/images&quot;
</code></pre>
<p>Image gets deleted when module is deleted from the user dashboard.</p>
<h3 id="offlineevent">OfflineEvent</h3>
<p>Module inherits from adhocracy4 UserGeneratedContentModel and has no image property.
Images can be uploaded via CKEditor5.</p>
<h3 id="debate">Debate</h3>
<p>Module is defined as Subject class and inherits from adhocracy4 Item and has no image property.</p>
<h3 id="document">Document</h3>
<p>Module is defined as Chapter class and inherits from adhocracy4 Item. 
It has a one to many relation with Paragraph class, which inherits from adhocracy4 TimeStampedModel.
Paragraph can have images uploaded from CKEditor5.</p>
<h3 id="poll">Poll</h3>
<p>Module inherits from adhocracy4 Item and has no image upload.</p>
<h3 id="map">Map</h3>
<p>Module inherits from adhocracy4 map fields and has no image upload property.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../project_insights/" class="btn btn-neutral float-left" title="project insights"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../software_architecture/" class="btn btn-neutral float-right" title="architecture">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../project_insights/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../software_architecture/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
